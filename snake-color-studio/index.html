<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake Color Studio</title>
<style>
/* ===== RESET & BASE ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0e0e12;
  --bg2: #16161c;
  --bg3: #1e1e26;
  --fg: #e0e0e8;
  --fg2: #a0a0b0;
  --accent: #6cf;
  --accent2: #f6c;
  --radius: 10px;
  --gap: 16px;
  --transition: 0.25s ease;
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { animation-duration: 0s !important; transition-duration: 0s !important; }
}

html { font-size: 15px; }
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg);
  color: var(--fg);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ===== HEADER ===== */
header {
  text-align: center;
  padding: 28px 16px 12px;
  position: relative;
  z-index: 10;
}
header h1 {
  font-size: 2rem;
  font-weight: 800;
  background: linear-gradient(135deg, #f66, #f90, #ff0, #0f0, #0ff, #66f, #f0f);
  background-size: 400% 400%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: gradShift 6s ease infinite;
}
header p { color: var(--fg2); margin-top: 4px; font-size: 0.9rem; }
@keyframes gradShift { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }

/* ===== NAV TABS ===== */
.tabs {
  display: flex;
  justify-content: center;
  gap: 6px;
  padding: 8px 16px;
  flex-wrap: wrap;
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--bg);
  border-bottom: 1px solid #2a2a34;
}
.tab-btn {
  background: var(--bg2);
  color: var(--fg2);
  border: 1px solid #2a2a34;
  padding: 8px 18px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
  transition: var(--transition);
}
.tab-btn:hover { border-color: var(--accent); color: var(--fg); }
.tab-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

/* ===== SECTIONS ===== */
.section { display: none; padding: 20px 16px 40px; max-width: 1100px; margin: 0 auto; }
.section.active { display: block; }

/* ===== CANVAS CONTAINER ===== */
#explorer-section { text-align: center; }
#snakeCanvas {
  display: block;
  margin: 0 auto 20px;
  border-radius: var(--radius);
  background: var(--bg2);
  border: 1px solid #2a2a34;
  cursor: crosshair;
  max-width: 100%;
}
.active-color-display {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}
.color-swatch-big {
  width: 100px;
  height: 100px;
  border-radius: var(--radius);
  border: 3px solid #444;
  transition: background var(--transition);
  box-shadow: 0 0 30px rgba(255,255,255,0.05);
}
.color-inputs { display: flex; flex-direction: column; gap: 8px; }
.color-inputs label { font-size: 0.8rem; color: var(--fg2); display: flex; align-items: center; gap: 8px; }
.color-inputs input[type="text"] {
  background: var(--bg3);
  border: 1px solid #333;
  color: var(--fg);
  padding: 6px 10px;
  border-radius: 6px;
  width: 140px;
  font-family: monospace;
  font-size: 0.85rem;
}
.slider-row { display: flex; align-items: center; gap: 12px; justify-content: center; margin-bottom: 16px; }
.slider-row label { font-size: 0.85rem; color: var(--fg2); }
.slider-row input[type="range"] { width: 260px; accent-color: var(--accent); }

/* ===== PALETTE ===== */
.palette-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: center; margin-bottom: 16px; }
.palette-controls select, .palette-controls button {
  background: var(--bg3);
  border: 1px solid #333;
  color: var(--fg);
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: var(--transition);
}
.palette-controls button:hover { border-color: var(--accent); }
.palette-bar {
  display: flex;
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 16px;
  height: 90px;
  border: 1px solid #333;
}
.palette-swatch {
  flex: 1;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding-bottom: 8px;
  cursor: pointer;
  position: relative;
  transition: flex var(--transition);
}
.palette-swatch:hover { flex: 1.5; }
.palette-swatch .label {
  font-size: 0.7rem;
  font-family: monospace;
  background: rgba(0,0,0,0.55);
  padding: 2px 6px;
  border-radius: 4px;
  color: #fff;
  pointer-events: none;
}
.palette-swatch .lock-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  background: rgba(0,0,0,0.4);
  border: none;
  color: #fff;
  font-size: 0.75rem;
  cursor: pointer;
  border-radius: 4px;
  padding: 2px 5px;
  opacity: 0;
  transition: opacity var(--transition);
}
.palette-swatch:hover .lock-btn { opacity: 1; }
.palette-swatch .lock-btn.locked { opacity: 1; color: #ff0; }

.export-row { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.export-row button {
  background: var(--bg3);
  border: 1px solid #333;
  color: var(--fg);
  padding: 6px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.8rem;
}
.export-row button:hover { border-color: var(--accent2); }

/* ===== CONTRAST ===== */
.contrast-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
@media (max-width: 700px) { .contrast-grid { grid-template-columns: 1fr; } }
.contrast-panel {
  background: var(--bg2);
  border-radius: var(--radius);
  padding: 20px;
  border: 1px solid #2a2a34;
}
.contrast-panel h3 { margin-bottom: 12px; font-size: 1rem; }
.contrast-preview {
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 16px;
  font-size: 1.1rem;
  text-align: center;
  min-height: 100px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  border: 1px solid #333;
}
.contrast-preview .big { font-size: 1.5rem; font-weight: 700; }
.contrast-preview .small { font-size: 0.85rem; margin-top: 6px; }
.contrast-ratio { font-size: 2rem; font-weight: 800; text-align: center; margin: 12px 0; }
.badges { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-bottom: 12px; }
.badge {
  padding: 4px 12px;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 700;
}
.badge.pass { background: #1a3a1a; color: #4f4; border: 1px solid #2a5a2a; }
.badge.fail { background: #3a1a1a; color: #f66; border: 1px solid #5a2a2a; }
.color-pick-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.color-pick-row label { font-size: 0.85rem; min-width: 90px; color: var(--fg2); }
.color-pick-row input[type="color"] { width: 50px; height: 34px; border: none; border-radius: 6px; cursor: pointer; background: transparent; }
.color-pick-row input[type="text"] {
  background: var(--bg3);
  border: 1px solid #333;
  color: var(--fg);
  padding: 6px 10px;
  border-radius: 6px;
  font-family: monospace;
  width: 100px;
}
.suggestion { background: var(--bg3); border-radius: 8px; padding: 12px; margin-top: 10px; font-size: 0.85rem; color: var(--fg2); }
.suggestion strong { color: var(--fg); }

/* ===== COLOR BLINDNESS ===== */
.cb-toggles { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-bottom: 16px; }
.cb-btn {
  background: var(--bg3);
  border: 1px solid #333;
  color: var(--fg);
  padding: 8px 16px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 0.8rem;
  transition: var(--transition);
}
.cb-btn:hover { border-color: var(--accent2); }
.cb-btn.active { background: var(--accent2); color: #000; border-color: var(--accent2); }
.cb-comparison {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2px;
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 16px;
  border: 1px solid #333;
}
.cb-col { padding: 12px; text-align: center; }
.cb-col h4 { font-size: 0.8rem; margin-bottom: 8px; color: var(--fg2); }
.cb-swatches { display: flex; gap: 4px; justify-content: center; flex-wrap: wrap; }
.cb-swatch {
  width: 50px; height: 50px; border-radius: 6px; display: flex; align-items: flex-end; justify-content: center;
  font-size: 0.6rem; font-family: monospace; color: #fff; padding-bottom: 3px;
  text-shadow: 0 0 4px #000;
}

/* ===== ACCESSIBLE PALETTE ===== */
.accessible-info {
  background: var(--bg2);
  border-radius: var(--radius);
  padding: 20px;
  border: 1px solid #2a2a34;
  margin-bottom: 16px;
}
.accessible-info p { color: var(--fg2); font-size: 0.9rem; line-height: 1.6; }
.a11y-status {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  font-weight: 700;
  font-size: 0.95rem;
}
.a11y-status.pass { background: #1a3a1a; color: #4f4; border: 1px solid #2a5a2a; }
.a11y-status.fail { background: #3a1a1a; color: #f66; border: 1px solid #5a2a2a; }
.a11y-details { font-size: 0.85rem; color: var(--fg2); }
.a11y-details table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.a11y-details th, .a11y-details td { padding: 8px 12px; border-bottom: 1px solid #2a2a34; text-align: left; }
.a11y-details th { color: var(--fg); font-weight: 600; }
.a11y-pair-pass { color: #4f4; }
.a11y-pair-fail { color: #f66; }

/* ===== TOAST ===== */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--accent);
  color: #000;
  padding: 10px 24px;
  border-radius: 999px;
  font-weight: 700;
  font-size: 0.85rem;
  z-index: 9999;
  opacity: 0;
  transition: transform 0.35s ease, opacity 0.35s ease;
  pointer-events: none;
}
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* ===== FOOTER ===== */
footer {
  text-align: center;
  padding: 24px;
  color: var(--fg2);
  font-size: 0.8rem;
  border-top: 1px solid #2a2a34;
}
</style>
</head>
<body>

<header>
  <h1>Snake Color Studio</h1>
  <p>Explore colors with a slithering RGB snake</p>
</header>

<nav class="tabs" role="tablist">
  <button class="tab-btn active" data-tab="explorer-section" role="tab" aria-selected="true">Explorer</button>
  <button class="tab-btn" data-tab="palette-section" role="tab" aria-selected="false">Palette</button>
  <button class="tab-btn" data-tab="contrast-section" role="tab" aria-selected="false">Contrast</button>
  <button class="tab-btn" data-tab="blindness-section" role="tab" aria-selected="false">Blindness Sim</button>
  <button class="tab-btn" data-tab="accessible-section" role="tab" aria-selected="false">Accessible</button>
</nav>

<!-- ==================== EXPLORER ==================== -->
<section id="explorer-section" class="section active" role="tabpanel">
  <canvas id="snakeCanvas" width="900" height="340" aria-label="Animated color snake explorer"></canvas>
  <div class="slider-row">
    <label for="hueSlider">Base Hue</label>
    <input type="range" id="hueSlider" min="0" max="360" value="0">
    <label for="arcSlider">Arc Spread</label>
    <input type="range" id="arcSlider" min="10" max="360" value="90">
  </div>
  <div class="active-color-display">
    <div class="color-swatch-big" id="activeColorSwatch"></div>
    <div class="color-inputs">
      <label>HEX <input type="text" id="hexInput" value="#FF0000"></label>
      <label>RGB <input type="text" id="rgbInput" value="255, 0, 0"></label>
      <label>HSL <input type="text" id="hslInput" value="0, 100%, 50%"></label>
    </div>
  </div>
</section>

<!-- ==================== PALETTE ==================== -->
<section id="palette-section" class="section" role="tabpanel">
  <div class="palette-controls">
    <select id="paletteMode">
      <option value="analogous">Analogous</option>
      <option value="complementary">Complementary</option>
      <option value="triadic">Triadic</option>
      <option value="split">Split-Complementary</option>
      <option value="tetradic">Tetradic</option>
      <option value="mono">Monochromatic</option>
    </select>
    <button id="randomizeBtn">Randomize</button>
    <button id="generateBtn">Generate</button>
  </div>
  <div class="palette-bar" id="paletteBar"></div>
  <div class="export-row">
    <button onclick="exportPalette('hex')">Copy HEX</button>
    <button onclick="exportPalette('rgb')">Copy RGB</button>
    <button onclick="exportPalette('css')">Copy CSS Vars</button>
    <button onclick="exportPalette('json')">Copy JSON</button>
    <button onclick="exportPalette('png')">Download PNG</button>
  </div>
</section>

<!-- ==================== CONTRAST ==================== -->
<section id="contrast-section" class="section" role="tabpanel">
  <div class="contrast-grid">
    <div class="contrast-panel">
      <h3>Pick Colors</h3>
      <div class="color-pick-row">
        <label>Foreground</label>
        <input type="color" id="contrastFg" value="#ffffff">
        <input type="text" id="contrastFgHex" value="#ffffff">
      </div>
      <div class="color-pick-row">
        <label>Background</label>
        <input type="color" id="contrastBg" value="#0e0e12">
        <input type="text" id="contrastBgHex" value="#0e0e12">
      </div>
      <button onclick="swapContrastColors()" style="margin-top:8px;background:var(--bg3);border:1px solid #333;color:var(--fg);padding:6px 16px;border-radius:6px;cursor:pointer;">Swap Colors</button>
      <div class="suggestion" id="contrastSuggestion"></div>
    </div>
    <div class="contrast-panel">
      <h3>Preview</h3>
      <div class="contrast-preview" id="contrastPreview">
        <span class="big">Sample Heading</span>
        <span class="small">This is body text for contrast evaluation.</span>
      </div>
      <div class="contrast-ratio" id="contrastRatioDisplay">21 : 1</div>
      <div class="badges" id="contrastBadges"></div>
    </div>
  </div>
</section>

<!-- ==================== COLOR BLINDNESS ==================== -->
<section id="blindness-section" class="section" role="tabpanel">
  <div class="cb-toggles" id="cbToggles">
    <button class="cb-btn active" data-type="protanopia">Protanopia</button>
    <button class="cb-btn" data-type="deuteranopia">Deuteranopia</button>
    <button class="cb-btn" data-type="tritanopia">Tritanopia</button>
    <button class="cb-btn" data-type="achromatopsia">Achromatopsia</button>
  </div>
  <div class="cb-comparison" id="cbComparison">
    <div class="cb-col">
      <h4>Original</h4>
      <div class="cb-swatches" id="cbOriginal"></div>
    </div>
    <div class="cb-col">
      <h4 id="cbSimLabel">Simulated (Protanopia)</h4>
      <div class="cb-swatches" id="cbSimulated"></div>
    </div>
  </div>
  <canvas id="snakeCanvasCB" width="900" height="200" aria-label="Snake preview with color blindness simulation" style="display:block;margin:0 auto;border-radius:var(--radius);border:1px solid #333;max-width:100%;background:var(--bg2);"></canvas>
</section>

<!-- ==================== ACCESSIBLE PALETTE ==================== -->
<section id="accessible-section" class="section" role="tabpanel">
  <div class="accessible-info">
    <p>Accessible Palette Mode automatically adjusts your generated palette so that:
      every adjacent color pair has at least 3:1 contrast,
      every color meets 4.5:1 contrast against both white and black,
      and no two colors are confusable under any simulated color vision deficiency (deltaE > 20).</p>
  </div>
  <div class="palette-controls">
    <select id="a11yPaletteMode">
      <option value="analogous">Analogous</option>
      <option value="complementary">Complementary</option>
      <option value="triadic">Triadic</option>
      <option value="split">Split-Complementary</option>
      <option value="tetradic">Tetradic</option>
      <option value="mono">Monochromatic</option>
    </select>
    <button id="a11yGenerateBtn">Generate Accessible Palette</button>
  </div>
  <div id="a11yStatus" class="a11y-status pass">Checking...</div>
  <div class="palette-bar" id="a11yPaletteBar"></div>
  <div class="a11y-details" id="a11yDetails"></div>
</section>

<footer>Snake Color Studio &mdash; No dependencies. Pure HTML + CSS + JS.</footer>
<div class="toast" id="toast"></div>

<script>
// =============================================================
//  UTILITIES
// =============================================================
function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v));}
function hexToRgb(h){h=h.replace('#','');if(h.length===3)h=h.split('').map(c=>c+c).join('');const n=parseInt(h,16);return[(n>>16)&255,(n>>8)&255,n&255];}
function rgbToHex(r,g,b){return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');}
function hslToRgb(h,s,l){h/=360;s/=100;l/=100;let r,g,b;if(s===0){r=g=b=l;}else{const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};const q=l<0.5?l*(1+s):l+s-l*s,p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];}
function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const mx=Math.max(r,g,b),mn=Math.min(r,g,b);let h,s,l=(mx+mn)/2;if(mx===mn){h=s=0;}else{const d=mx-mn;s=l>0.5?d/(2-mx-mn):d/(mx+mn);switch(mx){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break;}};return[Math.round(h*360),Math.round(s*100),Math.round(l*100)];}

function luminance(r,g,b){const a=[r,g,b].map(v=>{v/=255;return v<=0.03928?v/12.92:Math.pow((v+0.055)/1.055,2.4);});return 0.2126*a[0]+0.7152*a[1]+0.0722*a[2];}
function contrastRatio(rgb1,rgb2){const l1=luminance(...rgb1)+0.05,l2=luminance(...rgb2)+0.05;return l1>l2?l1/l2:l2/l1;}

function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);}

// =============================================================
//  COLOR BLINDNESS MATRICES (Brettel / Vienot)
// =============================================================
const cbMatrices = {
  protanopia:    [[0.567,0.433,0],[0.558,0.442,0],[0,0.242,0.758]],
  deuteranopia:  [[0.625,0.375,0],[0.7,0.3,0],[0,0.3,0.7]],
  tritanopia:    [[0.95,0.05,0],[0,0.433,0.567],[0,0.475,0.525]],
  achromatopsia: [[0.299,0.587,0.114],[0.299,0.587,0.114],[0.299,0.587,0.114]]
};
function simulateCB(rgb, type){
  const m=cbMatrices[type];if(!m)return rgb;
  return [
    clamp(Math.round(m[0][0]*rgb[0]+m[0][1]*rgb[1]+m[0][2]*rgb[2]),0,255),
    clamp(Math.round(m[1][0]*rgb[0]+m[1][1]*rgb[1]+m[1][2]*rgb[2]),0,255),
    clamp(Math.round(m[2][0]*rgb[0]+m[2][1]*rgb[1]+m[2][2]*rgb[2]),0,255)
  ];
}

// deltaE (simple CIE76-like via sRGB — good enough for simulation comparison)
function colorDist(a,b){return Math.sqrt((a[0]-b[0])**2+(a[1]-b[1])**2+(a[2]-b[2])**2);}

// =============================================================
//  TAB SWITCHING
// =============================================================
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>{b.classList.remove('active');b.setAttribute('aria-selected','false');});
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    btn.classList.add('active');
    btn.setAttribute('aria-selected','true');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

// =============================================================
//  SNAKE EXPLORER
// =============================================================
const canvas = document.getElementById('snakeCanvas');
const ctx = canvas.getContext('2d');
const hueSlider = document.getElementById('hueSlider');
const arcSlider = document.getElementById('arcSlider');
let baseHue = 0, hueArc = 90;
let activeColor = [255,0,0];
const SEGMENTS = 50;
const SEG_RADIUS = 12;
let time = 0;
const snakeSegments = []; // store positions for hit testing

// Resize canvas
function resizeCanvas(){
  const w = Math.min(900, canvas.parentElement.clientWidth - 32);
  canvas.width = w;
  canvas.height = Math.round(w * 0.38);
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

function getSnakeY(x, t){
  const amp = canvas.height * 0.3;
  return canvas.height/2 + amp * Math.sin(x * 0.012 + t);
}

function drawSnake(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const segSpacing = (canvas.width - 40) / SEGMENTS;
  snakeSegments.length = 0;

  // Draw trail glow
  for(let i=0;i<SEGMENTS;i++){
    const x = 20 + i * segSpacing;
    const y = getSnakeY(x, time);
    const hue = (baseHue + (i/SEGMENTS) * hueArc) % 360;
    const rgb = hslToRgb(hue, 85, 55);
    snakeSegments.push({x, y, rgb, hue});
    ctx.beginPath();
    ctx.arc(x, y, SEG_RADIUS + 8, 0, Math.PI*2);
    ctx.fillStyle = `rgba(${rgb[0]},${rgb[1]},${rgb[2]},0.08)`;
    ctx.fill();
  }

  // Links between segments
  for(let i=1;i<snakeSegments.length;i++){
    const a=snakeSegments[i-1], b=snakeSegments[i];
    ctx.beginPath();
    ctx.moveTo(a.x,a.y);
    ctx.lineTo(b.x,b.y);
    ctx.strokeStyle=`rgba(${a.rgb[0]},${a.rgb[1]},${a.rgb[2]},0.3)`;
    ctx.lineWidth=SEG_RADIUS*1.2;
    ctx.lineCap='round';
    ctx.stroke();
  }

  // Segments
  for(let i=0;i<snakeSegments.length;i++){
    const s=snakeSegments[i];
    const isHead = i===snakeSegments.length-1;
    const r = isHead ? SEG_RADIUS + 4 + 2*Math.sin(time*3) : SEG_RADIUS;
    ctx.beginPath();
    ctx.arc(s.x,s.y,r,0,Math.PI*2);
    ctx.fillStyle=rgbToHex(...s.rgb);
    ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.15)';
    ctx.lineWidth=1.5;
    ctx.stroke();
    if(isHead){
      // Eyes
      const angle = Math.atan2(s.y - snakeSegments[i-1].y, s.x - snakeSegments[i-1].x);
      const ex1 = s.x + Math.cos(angle+0.5)*r*0.45;
      const ey1 = s.y + Math.sin(angle+0.5)*r*0.45;
      const ex2 = s.x + Math.cos(angle-0.5)*r*0.45;
      const ey2 = s.y + Math.sin(angle-0.5)*r*0.45;
      ctx.beginPath();ctx.arc(ex1,ey1,3,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
      ctx.beginPath();ctx.arc(ex2,ey2,3,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
      ctx.beginPath();ctx.arc(ex1+1,ey1,1.5,0,Math.PI*2);ctx.fillStyle='#000';ctx.fill();
      ctx.beginPath();ctx.arc(ex2+1,ey2,1.5,0,Math.PI*2);ctx.fillStyle='#000';ctx.fill();
    }
  }
}

function animateSnake(){
  time += 0.025;
  if(!document.hidden) drawSnake();
  requestAnimationFrame(animateSnake);
}
animateSnake();

// Interactivity
canvas.addEventListener('click', e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=(e.clientX-rect.left)*(canvas.width/rect.width);
  const my=(e.clientY-rect.top)*(canvas.height/rect.height);
  for(let i=snakeSegments.length-1;i>=0;i--){
    const s=snakeSegments[i];
    if(Math.hypot(s.x-mx,s.y-my)<SEG_RADIUS+4){
      setActiveColor(s.rgb);
      break;
    }
  }
});

canvas.addEventListener('mousemove', e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=(e.clientX-rect.left)*(canvas.width/rect.width);
  const my=(e.clientY-rect.top)*(canvas.height/rect.height);
  let hit=false;
  for(const s of snakeSegments){
    if(Math.hypot(s.x-mx,s.y-my)<SEG_RADIUS+4){
      canvas.title=`${rgbToHex(...s.rgb)}  RGB(${s.rgb.join(', ')})  HSL(${rgbToHsl(...s.rgb).join(', ')})`;
      hit=true;break;
    }
  }
  if(!hit)canvas.title='';
});

hueSlider.addEventListener('input', e=>{ baseHue=+e.target.value; });
arcSlider.addEventListener('input', e=>{ hueArc=+e.target.value; });

function setActiveColor(rgb){
  activeColor=rgb;
  const swatch=document.getElementById('activeColorSwatch');
  swatch.style.background=rgbToHex(...rgb);
  document.getElementById('hexInput').value=rgbToHex(...rgb);
  document.getElementById('rgbInput').value=rgb.join(', ');
  document.getElementById('hslInput').value=rgbToHsl(...rgb).join(', ');
}
setActiveColor([255,0,0]);

// Editable inputs
document.getElementById('hexInput').addEventListener('change', e=>{
  try{const rgb=hexToRgb(e.target.value);setActiveColor(rgb);}catch(ex){}
});
document.getElementById('rgbInput').addEventListener('change', e=>{
  const parts=e.target.value.split(',').map(Number);
  if(parts.length===3&&parts.every(v=>v>=0&&v<=255))setActiveColor(parts);
});

// =============================================================
//  PALETTE GENERATOR
// =============================================================
let paletteColors = [];
let lockedIndices = new Set();

function generatePalette(mode, bh){
  const colors=[];
  const h=bh!==undefined?bh:Math.random()*360;
  switch(mode){
    case 'analogous':
      for(let i=-2;i<=2;i++) colors.push(hslToRgb((h+i*15+360)%360,75,55));
      break;
    case 'complementary':
      colors.push(hslToRgb(h,75,55));
      colors.push(hslToRgb((h+60)%360,50,65));
      colors.push(hslToRgb((h+180)%360,75,55));
      colors.push(hslToRgb((h+210)%360,50,65));
      colors.push(hslToRgb((h+180)%360,60,40));
      break;
    case 'triadic':
      [0,120,240].forEach(off=>colors.push(hslToRgb((h+off)%360,70,55)));
      colors.push(hslToRgb(h,40,75));
      colors.push(hslToRgb((h+120)%360,40,75));
      break;
    case 'split':
      colors.push(hslToRgb(h,75,55));
      colors.push(hslToRgb((h+150)%360,70,55));
      colors.push(hslToRgb((h+210)%360,70,55));
      colors.push(hslToRgb((h+150)%360,50,40));
      colors.push(hslToRgb((h+210)%360,50,40));
      break;
    case 'tetradic':
      [0,90,180,270].forEach(off=>colors.push(hslToRgb((h+off)%360,65,55)));
      colors.push(hslToRgb(h,40,70));
      break;
    case 'mono':
      for(let i=0;i<5;i++) colors.push(hslToRgb(h,70,25+i*13));
      break;
  }
  return colors;
}

function renderPalette(colors, containerId){
  const bar=document.getElementById(containerId);
  bar.innerHTML='';
  colors.forEach((c,i)=>{
    const div=document.createElement('div');
    div.className='palette-swatch';
    div.style.background=rgbToHex(...c);
    div.innerHTML=`<span class="label">${rgbToHex(...c)}</span>`;
    if(containerId==='paletteBar'){
      const lockBtn=document.createElement('button');
      lockBtn.className='lock-btn'+(lockedIndices.has(i)?' locked':'');
      lockBtn.textContent=lockedIndices.has(i)?'Locked':'Lock';
      lockBtn.onclick=(e)=>{e.stopPropagation();toggleLock(i);};
      div.appendChild(lockBtn);
    }
    div.onclick=()=>{navigator.clipboard.writeText(rgbToHex(...c));showToast('Copied '+rgbToHex(...c));};
    bar.appendChild(div);
  });
}

function toggleLock(i){
  if(lockedIndices.has(i))lockedIndices.delete(i);else lockedIndices.add(i);
  renderPalette(paletteColors,'paletteBar');
}

function doGenerate(){
  const mode=document.getElementById('paletteMode').value;
  const hsl=rgbToHsl(...activeColor);
  const newColors=generatePalette(mode, hsl[0]);
  paletteColors=newColors.map((c,i)=>lockedIndices.has(i)&&paletteColors[i]?paletteColors[i]:c);
  renderPalette(paletteColors,'paletteBar');
  updateCBView();
}

document.getElementById('generateBtn').addEventListener('click', doGenerate);
document.getElementById('randomizeBtn').addEventListener('click',()=>{
  baseHue=Math.random()*360;
  hueSlider.value=baseHue;
  setActiveColor(hslToRgb(baseHue,75,55));
  doGenerate();
});

// Initial palette
paletteColors=generatePalette('analogous',0);
renderPalette(paletteColors,'paletteBar');

// Export
function exportPalette(fmt){
  const hexes=paletteColors.map(c=>rgbToHex(...c));
  let text='';
  switch(fmt){
    case 'hex':text=hexes.join(', ');break;
    case 'rgb':text=paletteColors.map(c=>`rgb(${c.join(', ')})`).join('\n');break;
    case 'css':text=hexes.map((h,i)=>`--color-${i+1}: ${h};`).join('\n');break;
    case 'json':text=JSON.stringify(hexes,null,2);break;
    case 'png':exportPNG();return;
  }
  navigator.clipboard.writeText(text);showToast('Copied to clipboard!');
}
function exportPNG(){
  const c=document.createElement('canvas');c.width=paletteColors.length*120;c.height=120;
  const x=c.getContext('2d');
  paletteColors.forEach((col,i)=>{x.fillStyle=rgbToHex(...col);x.fillRect(i*120,0,120,120);
    x.fillStyle='#fff';x.font='bold 11px monospace';x.fillText(rgbToHex(...col),i*120+10,110);});
  const a=document.createElement('a');a.download='palette.png';a.href=c.toDataURL();a.click();
  showToast('PNG downloaded!');
}

// =============================================================
//  CONTRAST CHECKER
// =============================================================
const cFg=document.getElementById('contrastFg');
const cBg=document.getElementById('contrastBg');
const cFgH=document.getElementById('contrastFgHex');
const cBgH=document.getElementById('contrastBgHex');

function updateContrast(){
  const fg=hexToRgb(cFg.value), bg=hexToRgb(cBg.value);
  cFgH.value=cFg.value; cBgH.value=cBg.value;
  const preview=document.getElementById('contrastPreview');
  preview.style.color=cFg.value;
  preview.style.background=cBg.value;
  const ratio=contrastRatio(fg,bg);
  document.getElementById('contrastRatioDisplay').textContent=ratio.toFixed(2)+' : 1';
  const badges=document.getElementById('contrastBadges');
  badges.innerHTML=[
    ['AA Normal',ratio>=4.5],['AA Large',ratio>=3],['AAA Normal',ratio>=7],['AAA Large',ratio>=4.5]
  ].map(([l,p])=>`<span class="badge ${p?'pass':'fail'}">${l}: ${p?'PASS':'FAIL'}</span>`).join('');

  // Suggestion
  const sug=document.getElementById('contrastSuggestion');
  if(ratio<4.5){
    const adjusted=suggestAccessible(fg,bg);
    sug.innerHTML=`<strong>Suggestion:</strong> Adjust foreground to <span style="color:${rgbToHex(...adjusted)};font-weight:bold">${rgbToHex(...adjusted)}</span> for AA compliance.`;
  }else{sug.textContent='';}
}

function suggestAccessible(fg,bg){
  const hsl=rgbToHsl(...fg);
  for(let delta=1;delta<=80;delta++){
    for(const dir of [-1,1]){
      const nl=clamp(hsl[2]+delta*dir,0,100);
      const candidate=hslToRgb(hsl[0],hsl[1],nl);
      if(contrastRatio(candidate,bg)>=4.5) return candidate;
    }
  }
  return fg;
}

function swapContrastColors(){
  const tmp=cFg.value;cFg.value=cBg.value;cBg.value=tmp;updateContrast();
}

cFg.addEventListener('input',updateContrast);
cBg.addEventListener('input',updateContrast);
cFgH.addEventListener('change',e=>{cFg.value=e.target.value;updateContrast();});
cBgH.addEventListener('change',e=>{cBg.value=e.target.value;updateContrast();});
updateContrast();

// =============================================================
//  COLOR BLINDNESS SIMULATOR
// =============================================================
let currentCBType='protanopia';

document.querySelectorAll('.cb-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.cb-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentCBType=btn.dataset.type;
    document.getElementById('cbSimLabel').textContent='Simulated ('+btn.textContent+')';
    updateCBView();
  });
});

function updateCBView(){
  const origContainer=document.getElementById('cbOriginal');
  const simContainer=document.getElementById('cbSimulated');
  origContainer.innerHTML='';
  simContainer.innerHTML='';
  paletteColors.forEach(c=>{
    const d1=document.createElement('div');d1.className='cb-swatch';
    d1.style.background=rgbToHex(...c);d1.textContent=rgbToHex(...c);
    origContainer.appendChild(d1);
    const sim=simulateCB(c,currentCBType);
    const d2=document.createElement('div');d2.className='cb-swatch';
    d2.style.background=rgbToHex(...sim);d2.textContent=rgbToHex(...sim);
    simContainer.appendChild(d2);
  });
  drawCBSnake();
}

// CB Snake mini preview
const cbCanvas=document.getElementById('snakeCanvasCB');
const cbCtx=cbCanvas.getContext('2d');
function resizeCBCanvas(){
  const w=Math.min(900,cbCanvas.parentElement.clientWidth-32);
  cbCanvas.width=w;cbCanvas.height=Math.round(w*0.22);
}
resizeCBCanvas();
window.addEventListener('resize',resizeCBCanvas);

function drawCBSnake(){
  cbCtx.clearRect(0,0,cbCanvas.width,cbCanvas.height);
  const segSpacing=(cbCanvas.width-40)/SEGMENTS;
  for(let i=0;i<SEGMENTS;i++){
    const x=20+i*segSpacing;
    const y=cbCanvas.height/2+cbCanvas.height*0.3*Math.sin(x*0.012+time);
    const hue=(baseHue+(i/SEGMENTS)*hueArc)%360;
    const rgb=hslToRgb(hue,85,55);
    const sim=simulateCB(rgb,currentCBType);
    // top half original, bottom half simulated
    cbCtx.beginPath();cbCtx.arc(x,y,SEG_RADIUS-2,Math.PI,0);
    cbCtx.fillStyle=rgbToHex(...rgb);cbCtx.fill();
    cbCtx.beginPath();cbCtx.arc(x,y,SEG_RADIUS-2,0,Math.PI);
    cbCtx.fillStyle=rgbToHex(...sim);cbCtx.fill();
    cbCtx.beginPath();cbCtx.arc(x,y,SEG_RADIUS-2,0,Math.PI*2);
    cbCtx.strokeStyle='rgba(255,255,255,0.12)';cbCtx.lineWidth=1;cbCtx.stroke();
  }
}
updateCBView();

// =============================================================
//  ACCESSIBLE PALETTE MODE
// =============================================================
document.getElementById('a11yGenerateBtn').addEventListener('click', generateA11yPalette);

function generateA11yPalette(){
  const mode=document.getElementById('a11yPaletteMode').value;
  const hsl=rgbToHsl(...activeColor);
  let colors=generatePalette(mode, hsl[0]);
  const issues=[];

  // Enforce constraints
  const maxIter=100;
  for(let iter=0;iter<maxIter;iter++){
    let allPass=true;

    // 1. Adjacent pair contrast >= 3:1
    for(let i=0;i<colors.length-1;i++){
      const cr=contrastRatio(colors[i],colors[i+1]);
      if(cr<3){
        allPass=false;
        const h=rgbToHsl(...colors[i+1]);
        const dir=luminance(...colors[i])>0.5?-1:1;
        colors[i+1]=hslToRgb(h[0],h[1],clamp(h[2]+dir*5,10,90));
      }
    }

    // 2. Contrast vs white & black >= 4.5:1
    for(let i=0;i<colors.length;i++){
      const crW=contrastRatio(colors[i],[255,255,255]);
      const crB=contrastRatio(colors[i],[0,0,0]);
      if(crW<4.5&&crB<4.5){
        allPass=false;
        const h=rgbToHsl(...colors[i]);
        // push toward middle
        const newL=clamp(h[2]+(h[2]>50?-5:5),15,85);
        colors[i]=hslToRgb(h[0],h[1],newL);
      }
    }

    // 3. Distinguishable under all CB types (deltaE > 20)
    for(let i=0;i<colors.length;i++){
      for(let j=i+1;j<colors.length;j++){
        for(const type of Object.keys(cbMatrices)){
          const sA=simulateCB(colors[i],type);
          const sB=simulateCB(colors[j],type);
          const dist=colorDist(sA,sB);
          if(dist<20){
            allPass=false;
            const h=rgbToHsl(...colors[j]);
            colors[j]=hslToRgb((h[0]+15)%360,h[1],clamp(h[2]+5,15,85));
          }
        }
      }
    }

    if(allPass) break;
  }

  renderPalette(colors,'a11yPaletteBar');

  // Build report
  let allGood=true;
  let html='<table><tr><th>Check</th><th>Status</th></tr>';

  // Adjacent contrast
  for(let i=0;i<colors.length-1;i++){
    const cr=contrastRatio(colors[i],colors[i+1]);
    const pass=cr>=3;
    if(!pass)allGood=false;
    html+=`<tr><td>Pair ${i+1}-${i+2} contrast</td><td class="${pass?'a11y-pair-pass':'a11y-pair-fail'}">${cr.toFixed(2)}:1 ${pass?'PASS':'FAIL'}</td></tr>`;
  }

  // vs white & black
  colors.forEach((c,i)=>{
    const crW=contrastRatio(c,[255,255,255]);
    const crB=contrastRatio(c,[0,0,0]);
    const pass=crW>=4.5||crB>=4.5;
    if(!pass)allGood=false;
    html+=`<tr><td>Color ${i+1} vs W/B</td><td class="${pass?'a11y-pair-pass':'a11y-pair-fail'}">W:${crW.toFixed(1)} B:${crB.toFixed(1)} ${pass?'PASS':'FAIL'}</td></tr>`;
  });

  // CB distinguishability
  for(let i=0;i<colors.length;i++){
    for(let j=i+1;j<colors.length;j++){
      let minDist=Infinity,worstType='';
      for(const type of Object.keys(cbMatrices)){
        const d=colorDist(simulateCB(colors[i],type),simulateCB(colors[j],type));
        if(d<minDist){minDist=d;worstType=type;}
      }
      const pass=minDist>=20;
      if(!pass)allGood=false;
      html+=`<tr><td>${i+1} vs ${j+1} (${worstType})</td><td class="${pass?'a11y-pair-pass':'a11y-pair-fail'}">dE=${minDist.toFixed(0)} ${pass?'PASS':'FAIL'}</td></tr>`;
    }
  }

  html+='</table>';
  document.getElementById('a11yDetails').innerHTML=html;
  const status=document.getElementById('a11yStatus');
  status.className='a11y-status '+(allGood?'pass':'fail');
  status.textContent=allGood?'All accessibility checks passed':'Some checks did not pass — colors were adjusted as far as possible';
}
generateA11yPalette();

</script>
</body>
</html>
