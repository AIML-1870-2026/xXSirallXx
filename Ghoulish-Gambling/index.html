<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ghoulish Gambling ‚Äî Blackjack</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
<style>
/* ===== RESET ===== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --black:   #080810;
  --surface: #12121e;
  --panel:   #191926;
  --felt:    #0b1f0e;
  --gold:    #c9a84c;
  --gold2:   #e8c96a;
  --purple:  #7b2fff;
  --purple2: #4a1a99;
  --orange:  #ff6b1a;
  --green:   #22cc66;
  --red:     #ff2244;
  --bone:    #ede8d8;
  --dim:     #666;
  --cw: 72px;
  --ch: 104px;
  --ease: cubic-bezier(0.4, 0, 0.2, 1);
}
html, body { height: 100%; overflow: hidden; }
body {
  font-family: 'Cinzel', Georgia, serif;
  background: var(--black);
  color: var(--bone);
  display: flex; align-items: center; justify-content: center;
  min-height: 100vh;
  user-select: none;
}

/* ===== SCREENS ===== */
.screen {
  position: absolute; inset: 0;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.4s var(--ease);
}
.screen.hidden { opacity: 0; pointer-events: none; }

/* ============================
   TITLE SCREEN
   ============================ */
#titleScreen {
  background: radial-gradient(ellipse 80% 60% at 50% 42%, #220044 0%, #0a0a12 65%);
  gap: 14px;
}
.ghost-float {
  position: absolute; font-size: 2.4rem;
  animation: ghostDrift 9s ease-in-out infinite;
  opacity: 0.1; pointer-events: none;
}
.g1 { top: 8%;  left: 8%;  animation-delay: 0s; }
.g2 { top: 14%; right:11%; animation-delay: 2.5s; font-size:1.8rem; }
.g3 { bottom:18%; left:14%; animation-delay: 5s;  font-size:2rem; }
.g4 { bottom:24%; right:7%; animation-delay: 1s;  font-size:1.5rem; }
.g5 { top:48%; left:4%;     animation-delay: 3.5s; font-size:1.2rem; }
@keyframes ghostDrift {
  0%,100% { transform: translateY(0) rotate(-4deg); }
  50%      { transform: translateY(-28px) rotate(4deg); }
}
.title-skull {
  font-size: 4.5rem;
  animation: skullPulse 2.5s ease-in-out infinite;
  filter: drop-shadow(0 0 18px var(--purple));
}
@keyframes skullPulse {
  0%,100% { filter:drop-shadow(0 0 18px var(--purple)); transform:scale(1); }
  50%      { filter:drop-shadow(0 0 38px var(--orange)); transform:scale(1.06); }
}
.title-main {
  font-size: clamp(2rem, 6vw, 4.5rem); font-weight: 900;
  background: linear-gradient(135deg, var(--orange) 0%, var(--gold) 50%, var(--orange) 100%);
  background-size: 200%;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  animation: shimmer 3s linear infinite;
  text-align: center; letter-spacing: 0.05em;
}
@keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
.title-sub {
  font-size: clamp(0.8rem, 2vw, 1.05rem);
  color: var(--purple); letter-spacing: 0.3em; text-transform: uppercase;
  text-align: center; opacity: 0.9;
}
.title-rule {
  width: 120px; height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold), transparent);
  margin: 4px 0;
}
.btn-primary {
  padding: 14px 52px;
  font-family: 'Cinzel', serif; font-size: 1.1rem; font-weight: 700;
  background: linear-gradient(135deg, var(--purple2), var(--purple));
  color: #fff; border: 2px solid var(--purple); border-radius: 999px;
  cursor: pointer; letter-spacing: 0.15em; text-transform: uppercase;
  box-shadow: 0 0 32px rgba(123,47,255,.35), 0 4px 16px rgba(0,0,0,.5);
  transition: all 0.2s; margin-top: 6px;
}
.btn-primary:hover { transform: translateY(-2px) scale(1.04); box-shadow: 0 0 52px rgba(123,47,255,.55), 0 8px 24px rgba(0,0,0,.6); }
.btn-primary:active { transform: none; }
.title-hints {
  font-size: 0.68rem; color: var(--dim);
  font-family: system-ui, monospace; letter-spacing: 0.06em;
  margin-top: 8px; text-align: center;
}

/* ============================
   GAME SCREEN
   ============================ */
#gameScreen {
  flex-direction: column; justify-content: stretch; padding: 0; overflow: hidden;
}

/* --- HUD --- */
.hud {
  width: 100%; display: flex; align-items: center; justify-content: space-between;
  padding: 9px 20px;
  background: rgba(0,0,0,.62);
  border-bottom: 1px solid rgba(255,255,255,.05);
  flex-shrink: 0; gap: 10px;
}
.hud-brand { font-size: .9rem; font-weight: 700; color: var(--gold); letter-spacing: .12em; white-space: nowrap; }
.hud-stats { display: flex; gap: 18px; align-items: center; }
.hud-stat  { display: flex; flex-direction: column; align-items: center; gap: 1px; }
.hud-lbl   { font-size: .55rem; color: var(--dim); text-transform: uppercase; letter-spacing: .12em; font-family: system-ui, sans-serif; }
.hud-val   { font-size: .95rem; font-weight: 700; line-height: 1; }
.hud-val.g { color: var(--gold); }
.hud-val.gr{ color: var(--green); }
.strikes   { display: flex; gap: 4px; align-items: center; }
.s-dot     { width: 9px; height: 9px; border-radius: 50%; background: #333; transition: all .35s; }
.s-dot.lit { background: var(--red); box-shadow: 0 0 7px var(--red); }

/* --- TABLE --- */
.table {
  flex: 1; width: 100%; position: relative;
  display: flex; flex-direction: column; overflow: hidden;
  background:
    radial-gradient(ellipse 90% 55% at 50% 28%, rgba(18,56,18,.75) 0%, transparent 70%),
    radial-gradient(ellipse 100% 100% at 50% 50%, #0c200d 0%, #060e07 100%);
}
.table::before {
  content: ''; position: absolute; inset: 14px;
  border: 1px solid rgba(255,255,255,.035); border-radius: 130px;
  pointer-events: none; z-index: 0;
}

/* --- Swap banner --- */
.swap-banner {
  position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
  background: linear-gradient(135deg, var(--purple2), var(--purple));
  color: #fff; padding: 5px 18px; border-radius: 999px;
  font-size: .7rem; font-weight: 700; letter-spacing: .1em; white-space: nowrap;
  box-shadow: 0 0 16px rgba(123,47,255,.5);
  display: none; z-index: 10;
  animation: bannerPulse 1.2s ease-in-out infinite;
}
@keyframes bannerPulse { 0%,100%{opacity:1} 50%{opacity:.6} }
.swap-banner.on { display: block; }

/* --- Opponents row (NPCs + dealer) --- */
.opponents-row {
  display: flex; align-items: flex-start; justify-content: space-around;
  width: 100%; padding: 14px 20px 4px; position: relative; z-index: 1;
}
.npc-zone {
  display: flex; flex-direction: column; align-items: center; gap: 5px;
  position: relative; min-width: 96px;
}
.npc-ava  { font-size: 1.5rem; opacity: .7; }
.npc-name { font-size: .6rem; color: var(--dim); letter-spacing: .1em; font-family: system-ui, sans-serif; }
.npc-react {
  position: absolute; top: -22px; font-size: 1.25rem;
  animation: reactPop 1.6s ease-out forwards; pointer-events: none; z-index: 10;
}
@keyframes reactPop { 0%{opacity:1;transform:translateY(0) scale(1)} 50%{transform:translateY(-10px) scale(1.35)} 100%{opacity:0;transform:translateY(-26px) scale(.8)} }

/* --- Dealer zone --- */
.dealer-zone {
  display: flex; flex-direction: column; align-items: center; gap: 6px;
  position: relative; z-index: 1;
}
.zone-lbl   { font-size: .6rem; text-transform: uppercase; letter-spacing: .2em; color: var(--dim); font-family: system-ui, sans-serif; }
.dealer-spr {
  font-size: 2.8rem; line-height: 1;
  animation: dealerIdle 3s ease-in-out infinite;
  filter: drop-shadow(0 0 8px rgba(255,107,26,.25));
}
@keyframes dealerIdle { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
.dealer-spr.charging {
  animation: dealerCharge .72s ease-in forwards !important;
  filter: drop-shadow(0 0 28px var(--red)) !important;
}
@keyframes dealerCharge {
  0%   { transform: translateX(0) scale(1); }
  20%  { transform: translateX(-14px) scale(1.1); }
  55%  { transform: translateX(38vw) scale(2.8); }
  100% { transform: translateX(48vw) scale(4); opacity: 0; }
}
.dealer-total { font-size: .82rem; color: var(--orange); font-weight: 700; min-height: 1.1rem; font-family: system-ui, sans-serif; }

/* --- Divider --- */
.felt-divider {
  width: calc(100% - 80px); height: 1px; margin: 6px auto;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.06), transparent);
  position: relative; z-index: 1;
}

/* --- Player zone --- */
.player-zone {
  display: flex; flex-direction: column; align-items: center; gap: 8px;
  padding: 8px 16px 14px; position: relative; z-index: 1;
  flex: 1; justify-content: flex-end;
}
.player-zone-lbl { font-size: .6rem; text-transform: uppercase; letter-spacing: .2em; color: var(--dim); font-family: system-ui, sans-serif; }
.player-total {
  font-size: 1.25rem; font-weight: 700; color: var(--green);
  min-height: 1.5rem; font-family: system-ui, sans-serif; transition: color .3s;
}
.player-total.bust { color: var(--red); }

/* ===== CARDS ===== */
.hand {
  display: flex; gap: 7px; flex-wrap: wrap;
  justify-content: center; align-items: flex-end;
  min-height: calc(var(--ch) + 4px);
}
.card {
  width: var(--cw); height: var(--ch);
  border-radius: 9px; flex-shrink: 0;
  display: flex; flex-direction: column; justify-content: space-between;
  padding: 5px 5px;
  border: 1px solid rgba(0,0,0,.12);
  box-shadow: 0 4px 12px rgba(0,0,0,.65), inset 0 1px 0 rgba(255,255,255,.28);
  position: relative; transition: transform .18s;
}
.card:hover:not(.back) { transform: translateY(-6px); }
@keyframes cDeal {
  from { transform: translateY(-44px) rotate(-7deg) scale(.8); opacity: 0; }
  to   { transform: none; opacity: 1; }
}
.card.red   { background: linear-gradient(155deg, #fff9f9, #fff0f0); color: #bf0025; }
.card.black { background: linear-gradient(155deg, #f9f9ff, #f0f0ff); color: #111; }
.card.back  {
  background: linear-gradient(145deg, #1e0044, #3a0080, #1e0044);
  border: 2px solid var(--purple);
  box-shadow: 0 4px 14px rgba(0,0,0,.7), 0 0 10px rgba(123,47,255,.2);
  cursor: pointer; overflow: hidden;
}
.card.back::before {
  content: '‚ú¶'; position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.8rem; color: rgba(123,47,255,.4);
  text-shadow: 0 0 10px rgba(123,47,255,.7);
}
.card.back::after {
  content: 'üëÅ'; position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.5rem; opacity: 0; transition: opacity .2s; z-index: 1;
}
.card.back:hover { border-color: var(--orange); box-shadow: 0 0 18px rgba(255,107,26,.4), 0 4px 14px rgba(0,0,0,.7); }
.card.back:hover::after { opacity: 1; }

.c-corner  { display: flex; flex-direction: column; align-items: flex-start; line-height: 1.1; }
.c-corner.bot { align-items: flex-end; transform: rotate(180deg); }
.c-val  { font-size: .82rem; font-weight: 900; }
.c-suit { font-size: .65rem; }
.c-mid  { font-size: 1.6rem; line-height: 1; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }

/* NPC smaller cards */
.ncard { --cw: 46px; --ch: 68px; width: 46px; height: 68px; border-radius: 7px; padding: 3px 3px; }
.ncard .c-mid { font-size: 1.1rem; }
.ncard .c-val { font-size: .65rem; }
.ncard.back::before { font-size: 1.3rem; }
.ncard.back::after  { font-size: 1.2rem; }

/* Split hand active highlight */
.split-active { outline: 2px solid var(--green); border-radius: 10px; padding: 4px; box-shadow: 0 0 14px rgba(34,204,102,.3); }

/* ===== RESULT OVERLAY (inside table) ===== */
#resultOverlay {
  position: absolute; inset: 0; z-index: 60;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: rgba(0,0,0,.72); backdrop-filter: blur(5px);
  opacity: 0; pointer-events: none; transition: opacity .35s;
}
#resultOverlay.show { opacity: 1; pointer-events: all; }
.result-box {
  background: var(--surface); border-radius: 20px;
  padding: 26px 48px; text-align: center;
  border: 2px solid var(--dim);
  box-shadow: 0 16px 60px rgba(0,0,0,.75);
  display: flex; flex-direction: column; align-items: center; gap: 8px;
  min-width: 240px;
  animation: rPop .4s cubic-bezier(.34,1.56,.64,1);
}
@keyframes rPop { from{transform:scale(.55) translateY(20px);opacity:0} to{transform:none;opacity:1} }
.result-box.win  { border-color: var(--gold);   }
.result-box.lose { border-color: var(--red);    }
.result-box.push { border-color: #555;          }
.result-box.bj   { border-color: var(--orange); }
.r-icon  { font-size: 2.4rem; }
.r-text  { font-size: 1.5rem; font-weight: 900; }
.r-text.win  { color: var(--gold);   }
.r-text.lose { color: var(--red);    }
.r-text.push { color: var(--bone);   }
.r-text.bj   { color: var(--orange); font-size: 1.8rem; }
.r-chips { font-size: .85rem; color: var(--dim); font-family: system-ui, sans-serif; margin-top: 2px; }
.r-chips .pos { color: var(--green); font-weight: 700; }
.r-chips .neg { color: var(--red); font-weight: 700; }

/* ===== PEEK RESULT ===== */
#peekBubble {
  position: absolute; top: 44%; left: 50%; transform: translate(-50%, -50%);
  background: rgba(8,0,20,.96); border: 2px solid var(--purple);
  border-radius: 14px; padding: 14px 26px; text-align: center;
  z-index: 45; font-family: system-ui, sans-serif; font-size: .9rem;
  box-shadow: 0 0 24px rgba(123,47,255,.4);
  opacity: 0; pointer-events: none; transition: opacity .25s;
}
#peekBubble.show { opacity: 1; }
#peekBubble strong { color: var(--purple); font-size: 1.05rem; }

/* ============================
   CONTROLS FOOTER
   ============================ */
.controls {
  width: 100%; background: rgba(0,0,0,.6);
  border-top: 1px solid rgba(255,255,255,.05);
  padding: 12px 20px; flex-shrink: 0;
  display: flex; flex-direction: column; align-items: center; gap: 8px;
}

/* Bet phase */
.bet-phase { display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; }
.bet-top   { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; justify-content: center; }
.bet-label { font-size: .68rem; text-transform: uppercase; letter-spacing: .14em; color: var(--dim); font-family: system-ui, sans-serif; text-align: center; }
.bet-amount { font-size: 1.9rem; font-weight: 900; color: var(--gold); text-align: center; min-width: 90px; }
.chips-row { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.chip {
  width: 44px; height: 44px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: .68rem; font-weight: 700; cursor: pointer;
  border: 3px dashed; transition: transform .15s, box-shadow .15s;
  font-family: system-ui, sans-serif;
}
.chip:hover  { transform: scale(1.18) translateY(-2px); }
.chip:active { transform: scale(1); }
.c10  { background:#191928; border-color:#777; color:#bbb; }
.c25  { background:#0c2200; border-color:#4caf50; color:#70da74; }
.c50  { background:#001840; border-color:#5090ff; color:#88aaff; }
.c100 { background:#280010; border-color:#e91e63; color:#ff6699; }
.c500 { background:#281600; border-color:var(--gold); color:var(--gold); }

.bet-bottom { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; }
.btn-clear {
  padding: 8px 18px; background: transparent;
  border: 1px solid var(--dim); border-radius: 7px;
  color: var(--dim); cursor: pointer; font-size: .78rem;
  font-family: 'Cinzel', serif; transition: all .2s;
}
.btn-clear:hover { border-color: var(--red); color: var(--red); }
.btn-deal-big {
  padding: 12px 44px; border-radius: 10px; border: none; cursor: pointer;
  font-family: 'Cinzel', serif; font-weight: 700; font-size: 1rem;
  background: linear-gradient(135deg, var(--purple2), var(--purple));
  color: #fff; letter-spacing: .12em;
  box-shadow: 0 4px 18px rgba(123,47,255,.35);
  transition: all .2s;
}
.btn-deal-big:hover { transform: translateY(-2px); box-shadow: 0 6px 28px rgba(123,47,255,.5); }
.btn-deal-big:disabled { opacity: .38; cursor: not-allowed; transform: none; }

/* Action phase */
.action-phase { display: flex; flex-direction: column; align-items: center; gap: 8px; width: 100%; }
.action-info  { font-size: .72rem; color: var(--dim); font-family: system-ui, sans-serif; text-align: center; }
.action-info span { color: var(--gold); font-weight: 700; font-size: .88rem; }
.action-btns  { display: flex; gap: 9px; flex-wrap: wrap; justify-content: center; }
.abtn {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  padding: 10px 18px; border-radius: 10px; border: none; cursor: pointer;
  font-family: 'Cinzel', serif; font-weight: 700; font-size: .88rem;
  transition: all .15s; min-width: 70px;
  box-shadow: 0 3px 10px rgba(0,0,0,.45);
  letter-spacing: .04em;
}
.abtn:hover:not(:disabled) { transform: translateY(-3px); filter: brightness(1.18); box-shadow: 0 7px 18px rgba(0,0,0,.5); }
.abtn:active:not(:disabled){ transform: none; }
.abtn:disabled { opacity: .28; cursor: not-allowed; }
.abtn .kh { font-size: .52rem; opacity: .45; font-family: monospace; }
.abtn-hit    { background: linear-gradient(145deg,#133a13,#1e621e); color:#aaffaa; border:1px solid rgba(34,204,102,.2); }
.abtn-stand  { background: linear-gradient(145deg,#3e1111,#651c1c); color:#ffaaaa; border:1px solid rgba(255,34,68,.2); }
.abtn-double { background: linear-gradient(145deg,#332300,#5a3d00); color:#ffd066; border:1px solid rgba(201,168,76,.2); }
.abtn-split  { background: linear-gradient(145deg,#111340,#1b1b60); color:#aaaaff; border:1px solid rgba(100,100,255,.2); }
.abtn-peek   { background: linear-gradient(145deg,#240040,#3f006c); color:#cc88ff; border:1px solid rgba(123,47,255,.3); }
.abtn-peek:hover:not(:disabled) { box-shadow: 0 0 22px rgba(123,47,255,.42); }

/* Dealer playing */
.dealer-phase { display: flex; align-items: center; gap: 12px; justify-content: center; color: var(--dim); font-family: system-ui, sans-serif; font-size: .88rem; }
.spin { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,.1); border-top-color: var(--orange); border-radius: 50%; animation: spin .8s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }

/* Next round */
.next-phase { text-align: center; }
.btn-next {
  padding: 12px 46px; border-radius: 10px; border: 2px solid var(--green);
  background: transparent; color: var(--green); cursor: pointer;
  font-family: 'Cinzel', serif; font-weight: 700; font-size: 1rem;
  letter-spacing: .12em; transition: all .2s;
  box-shadow: 0 0 18px rgba(34,204,102,.18);
}
.btn-next:hover { background: rgba(34,204,102,.1); box-shadow: 0 0 32px rgba(34,204,102,.35); transform: translateY(-2px); }

/* ============================
   SOUL SWAP OVERLAY
   ============================ */
#soulSwap {
  position: fixed; inset: 0; z-index: 200;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  pointer-events: none; opacity: 0; background: transparent;
  transition: opacity .35s, background .35s;
}
#soulSwap.on { opacity: 1; pointer-events: all; background: rgba(0,0,0,.92); }
.soul-orb   { font-size: 4.5rem; animation: sOrb 1.5s ease-in-out infinite alternate; }
@keyframes sOrb {
  from { transform:scale(1) rotate(-5deg); filter:drop-shadow(0 0 20px var(--purple)); }
  to   { transform:scale(1.12) rotate(5deg); filter:drop-shadow(0 0 50px var(--orange)); }
}
.soul-title { font-size: clamp(1.8rem,5vw,3.2rem); font-weight: 900; color: var(--purple); margin-top: 16px; letter-spacing: .1em; animation: sGlow .6s ease-in-out infinite alternate; }
@keyframes sGlow { from{text-shadow:0 0 22px var(--purple)} to{text-shadow:0 0 44px var(--orange),0 0 80px var(--purple)} }
.soul-sub   { font-size: .95rem; color: var(--bone); opacity: .75; margin-top: 12px; text-align: center; font-family: system-ui, sans-serif; max-width: 300px; }

/* ============================
   INSURANCE MODAL
   ============================ */
#insModal {
  position: absolute; inset: 0; z-index: 50;
  display: flex; align-items: center; justify-content: center;
  background: rgba(0,0,0,.72); backdrop-filter: blur(6px);
  opacity: 0; pointer-events: none; transition: opacity .25s;
}
#insModal.show { opacity: 1; pointer-events: all; }
.ins-box {
  background: var(--surface); border: 2px solid var(--gold);
  border-radius: 20px; padding: 28px 36px; text-align: center;
  box-shadow: 0 14px 54px rgba(0,0,0,.75);
  animation: rPop .35s cubic-bezier(.34,1.56,.64,1);
  max-width: 320px;
}
.ins-box h3 { font-size: 1.2rem; color: var(--gold); margin-bottom: 8px; }
.ins-box p  { font-size: .82rem; color: var(--dim); font-family: system-ui, sans-serif; line-height: 1.55; margin-bottom: 16px; }
.ins-btns   { display: flex; gap: 10px; justify-content: center; }
.ins-yes { padding:10px 24px; background:linear-gradient(135deg,#0c3000,#185000); color:#88ff88; border:1px solid #4caf50; border-radius:8px; cursor:pointer; font-family:'Cinzel',serif; font-weight:700; transition:all .2s; }
.ins-no  { padding:10px 24px; background:transparent; color:var(--dim); border:1px solid var(--dim); border-radius:8px; cursor:pointer; font-family:'Cinzel',serif; font-weight:700; transition:all .2s; }
.ins-yes:hover { background:linear-gradient(135deg,#185000,#287a00); transform:translateY(-1px); }
.ins-no:hover  { border-color:var(--red); color:var(--red); }

/* ============================
   CRACKED SCREEN
   ============================ */
#crack {
  position: fixed; inset: 0; z-index: 300;
  pointer-events: none; opacity: 0; transition: opacity .15s;
}
#crack.on { opacity: 1; }
#crack svg { width: 100%; height: 100%; position: absolute; inset: 0; }
.crack-vig {
  position: absolute; inset: 0;
  background: radial-gradient(ellipse at center, transparent 22%, rgba(200,0,40,.5) 100%);
}
.crack-warn {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
  font-family: 'Cinzel', serif; font-size: clamp(1rem,3.5vw,2rem); font-weight: 900;
  color: var(--red); text-align: center; text-shadow: 0 0 22px var(--red);
  animation: wFlash .14s linear infinite;
}
@keyframes wFlash { 0%,100%{opacity:1} 50%{opacity:.15} }

/* ============================
   GAME OVER
   ============================ */
#gameOverScreen {
  background: radial-gradient(ellipse at 50% 40%, #1a0000, var(--black) 68%);
  gap: 12px;
}
.go-ghost { font-size: 4.5rem; animation: goFloat 2.2s ease-in-out infinite; }
@keyframes goFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-22px)} }
.go-title { font-size: 2.5rem; font-weight: 900; color: var(--red); letter-spacing: .05em; }
.go-sub   { font-size: .95rem; color: var(--dim); font-family: system-ui, sans-serif; }
.go-chips { font-size: 1.3rem; color: var(--gold); }

/* ============================
   RESPONSIVE
   ============================ */
@media (max-height: 640px) {
  :root { --cw: 56px; --ch: 82px; }
  .dealer-spr { font-size: 2.2rem; }
  .controls { padding: 8px 16px; gap: 6px; }
  .opponents-row { padding: 8px 16px 2px; }
  .player-zone { padding: 4px 16px 10px; }
}
@media (max-width: 480px) {
  :root { --cw: 58px; --ch: 86px; }
  .abtn { min-width: 56px; padding: 8px 10px; font-size: .8rem; }
  .chip { width: 38px; height: 38px; }
}
</style>
</head>
<body>

<!-- ================================================================
     TITLE SCREEN
     ================================================================ -->
<div class="screen" id="titleScreen">
  <div class="ghost-float g1">üëª</div>
  <div class="ghost-float g2">üíÄ</div>
  <div class="ghost-float g3">ü¶á</div>
  <div class="ghost-float g4">üëÅ</div>
  <div class="ghost-float g5">üï∑</div>
  <div class="title-skull">üíÄ</div>
  <div class="title-main">GHOULISH GAMBLING</div>
  <div class="title-rule"></div>
  <div class="title-sub">Blackjack with a Spooky Twist</div>
  <button class="btn-primary" onclick="startGame()">üÉè &nbsp;Deal Me In</button>
  <div class="title-hints">[H] Hit &nbsp;¬∑&nbsp; [S] Stand &nbsp;¬∑&nbsp; [D] Double &nbsp;¬∑&nbsp; [P] Peek</div>
</div>

<!-- ================================================================
     GAME SCREEN
     ================================================================ -->
<div class="screen hidden" id="gameScreen">

  <!-- HUD -->
  <div class="hud">
    <div class="hud-brand">üíÄ GHOULISH</div>
    <div class="hud-stats">
      <div class="hud-stat">
        <div class="hud-lbl">Chips</div>
        <div class="hud-val g" id="hudChips">1000</div>
      </div>
      <div class="hud-stat">
        <div class="hud-lbl">Bet</div>
        <div class="hud-val gr" id="hudBet">‚Äî</div>
      </div>
      <div class="hud-stat">
        <div class="hud-lbl">Round</div>
        <div class="hud-val" id="hudRound">1</div>
      </div>
      <div class="hud-stat">
        <div class="hud-lbl">Strikes</div>
        <div class="strikes" id="hudStrikes">
          <div class="s-dot"></div>
          <div class="s-dot"></div>
          <div class="s-dot"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table" id="table">

    <div class="swap-banner" id="swapBanner">‚ö†Ô∏è SOUL SWAPPED ‚Äî YOU ARE THE DEALER</div>

    <!-- Insurance modal -->
    <div id="insModal">
      <div class="ins-box">
        <h3>üÉè Insurance?</h3>
        <p>Dealer shows an Ace. Bet half your wager as insurance against dealer Blackjack?</p>
        <div class="ins-btns">
          <button class="ins-yes" onclick="takeInsurance(true)">Take Insurance</button>
          <button class="ins-no"  onclick="takeInsurance(false)">No Thanks</button>
        </div>
      </div>
    </div>

    <!-- Peek bubble -->
    <div id="peekBubble"></div>

    <!-- Opponents -->
    <div class="opponents-row">
      <div class="npc-zone" id="npc1">
        <div class="npc-ava">üëª</div>
        <div class="hand" id="npc1Hand"></div>
        <div class="npc-name">Spectre</div>
      </div>

      <div class="dealer-zone">
        <div class="zone-lbl">Dealer</div>
        <div class="dealer-spr" id="dealerSpr">üíÄ</div>
        <div class="hand" id="dealerHand"></div>
        <div class="dealer-total" id="dealerTotal"></div>
      </div>

      <div class="npc-zone" id="npc2">
        <div class="npc-ava">ü¶á</div>
        <div class="hand" id="npc2Hand"></div>
        <div class="npc-name">Batilda</div>
      </div>
    </div>

    <div class="felt-divider"></div>

    <!-- Player -->
    <div class="player-zone">
      <div class="player-zone-lbl" id="playerLbl">Your Hand</div>
      <div class="hand" id="playerHand"></div>
      <div class="player-total" id="playerTotal"></div>
    </div>

    <!-- Result overlay -->
    <div id="resultOverlay">
      <div class="result-box" id="resultBox">
        <div class="r-icon" id="rIcon">üÉè</div>
        <div class="r-text" id="rText">WIN</div>
        <div class="r-chips" id="rChips"></div>
      </div>
    </div>

  </div><!-- /table -->

  <!-- CONTROLS FOOTER -->
  <div class="controls">

    <!-- BET PHASE -->
    <div class="bet-phase" id="betControls">
      <div class="bet-top">
        <div>
          <div class="bet-label">Current Bet</div>
          <div class="bet-amount" id="betAmt">$50</div>
        </div>
        <div class="chips-row">
          <div class="chip c10"  onclick="addChip(10)">10</div>
          <div class="chip c25"  onclick="addChip(25)">25</div>
          <div class="chip c50"  onclick="addChip(50)">50</div>
          <div class="chip c100" onclick="addChip(100)">100</div>
          <div class="chip c500" onclick="addChip(500)">500</div>
        </div>
      </div>
      <div class="bet-bottom">
        <button class="btn-clear" onclick="clearBet()">Clear</button>
        <button class="btn-deal-big" id="btnDeal" onclick="dealHand()">Deal ‚ñ∂</button>
      </div>
    </div>

    <!-- ACTION PHASE -->
    <div class="action-phase" id="actionControls" style="display:none">
      <div class="action-info" id="actionInfo">Bet: <span id="actionBet">$50</span></div>
      <div class="action-btns">
        <button class="abtn abtn-hit"    id="btnHit"    onclick="playerHit()">Hit<span class="kh">[H]</span></button>
        <button class="abtn abtn-stand"  id="btnStand"  onclick="playerStand()">Stand<span class="kh">[S]</span></button>
        <button class="abtn abtn-double" id="btnDouble" onclick="playerDouble()">Double<span class="kh">[D]</span></button>
        <button class="abtn abtn-split"  id="btnSplit"  onclick="playerSplit()">Split<span class="kh">[X]</span></button>
        <button class="abtn abtn-peek"   id="btnPeek"   onclick="attemptPeek()">üëÅ Peek<span class="kh">[P]</span></button>
      </div>
    </div>

    <!-- DEALER PLAYING -->
    <div class="dealer-phase" id="dealerControls" style="display:none">
      <div class="spin"></div>
      <span>Dealer is playing...</span>
    </div>

    <!-- NEXT ROUND -->
    <div class="next-phase" id="nextControls" style="display:none">
      <button class="btn-next" onclick="nextRound()">Next Round ‚ñ∂</button>
    </div>

  </div><!-- /controls -->

</div><!-- /gameScreen -->

<!-- ================================================================
     GAME OVER
     ================================================================ -->
<div class="screen hidden" id="gameOverScreen">
  <div class="go-ghost">üëª</div>
  <div class="go-title">GAME OVER</div>
  <div class="go-sub">Your soul now belongs to the house...</div>
  <div class="go-chips" id="goChips"></div>
  <button class="btn-primary" onclick="resetGame()" style="margin-top:10px">‚Ü∫ Play Again</button>
</div>

<!-- ================================================================
     SOUL SWAP OVERLAY
     ================================================================ -->
<div id="soulSwap">
  <div class="soul-orb">üåÄ</div>
  <div class="soul-title">SOUL SWAP!</div>
  <div class="soul-sub" id="soulSub"></div>
</div>

<!-- ================================================================
     CRACKED SCREEN
     ================================================================ -->
<div id="crack">
  <svg viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg">
    <g stroke="rgba(255,255,255,.82)" stroke-width="2.5" fill="none" stroke-linecap="round">
      <path d="M500,300 L420,180 L378,98"/>
      <path d="M500,300 L562,158 L602,78"/>
      <path d="M500,300 L652,222 L792,154"/>
      <path d="M500,300 L682,342 L832,380"/>
      <path d="M500,300 L622,422 L728,522"/>
      <path d="M500,300 L478,456 L458,564"/>
      <path d="M500,300 L358,402 L238,488"/>
      <path d="M500,300 L298,362 L152,344"/>
      <path d="M500,300 L338,242 L212,182"/>
      <path d="M420,180 L394,146 L346,126" stroke-width="1.5"/>
      <path d="M562,158 L594,136 L574,96"  stroke-width="1.5"/>
      <path d="M652,222 L704,200 L734,230" stroke-width="1.5"/>
      <path d="M478,456 L438,474 L400,452" stroke-width="1.5"/>
      <path d="M358,402 L328,434 L306,464" stroke-width="1.5"/>
      <path d="M338,242 L308,212 L278,242" stroke-width="1"/>
      <path d="M622,422 L662,442 L690,480" stroke-width="1"/>
    </g>
    <circle cx="500" cy="300" r="18" fill="rgba(255,255,255,.14)" stroke="rgba(255,255,255,.72)" stroke-width="2"/>
    <circle cx="500" cy="300" r="7"  fill="rgba(255,255,255,.42)"/>
  </svg>
  <div class="crack-vig"></div>
  <div class="crack-warn">‚ö†Ô∏è CAUGHT CHEATING ‚ö†Ô∏è<br><span style="font-size:.52em;letter-spacing:.1em">The skeleton is NOT pleased</span></div>
</div>

<script>
'use strict';

// ================================================================
// CARD ENGINE
// ================================================================
const SUITS  = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
const VALUES = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
const RED    = new Set(['‚ô•','‚ô¶']);

function createDeck() {
  const d = [];
  for (const s of SUITS) for (const v of VALUES) d.push({ suit: s, value: v });
  return d;
}
function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function cardValue(v) {
  if (v === 'A') return 11;
  if ('KQJ'.includes(v)) return 10;
  return parseInt(v);
}
function total(hand) {
  let t = 0, aces = 0;
  for (const c of hand) {
    if (c.hidden) continue;
    t += cardValue(c.value);
    if (c.value === 'A') aces++;
  }
  while (t > 21 && aces--) t -= 10;
  return t;
}

// ================================================================
// WEB AUDIO
// ================================================================
let audioCtx;
function ctx() { return audioCtx || (audioCtx = new (window.AudioContext||window.webkitAudioContext)()); }
function tone(freq, type, dur, vol = 0.13) {
  try {
    const c = ctx(), o = c.createOscillator(), g = c.createGain();
    o.connect(g); g.connect(c.destination);
    o.type = type; o.frequency.setValueAtTime(freq, c.currentTime);
    g.gain.setValueAtTime(vol, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + dur);
    o.start(); o.stop(c.currentTime + dur);
  } catch(e) {}
}
const sfxDeal   = () => { tone(440,'triangle',.09,.09); setTimeout(()=>tone(550,'triangle',.07,.07),55); };
const sfxWin    = () => [600,700,860,1020].forEach((f,i)=>setTimeout(()=>tone(f,'sine',.18,.13),i*85));
const sfxLose   = () => [280,240,200,150].forEach((f,i)=>setTimeout(()=>tone(f,'sawtooth',.22,.14),i*95));
const sfxSwap   = () => [200,320,440,320,200,440,660].forEach((f,i)=>setTimeout(()=>tone(f,'triangle',.28,.17),i*90));
const sfxCaught = () => { for(let i=0;i<14;i++) setTimeout(()=>{ tone(70+Math.random()*50,'sawtooth',.14,.28); tone(180+Math.random()*90,'square',.14,.22); },i*55); };

// ================================================================
// STATE
// ================================================================
const G = {
  deck: [], chips: 1000, bet: 50, round: 1,
  strikes: 0, maxStrikes: 3,
  phase: 'bet', // bet | player | dealer | over
  soulSwapped: false,
  roundsUntilSwap: rndSwap(),
  insurance: 0, insuranceTaken: false,
  playerHand: [], dealerHand: [],
  npc1Hand: [], npc2Hand: [],
  splitHands: null, splitIndex: 0,
};
function rndSwap() { return Math.floor(Math.random()*4)+3; }
function draw(hidden=false) {
  if (G.deck.length < 15) G.deck = shuffle([...createDeck(),...createDeck()]);
  return { ...G.deck.pop(), hidden };
}
function initDeck() { G.deck = shuffle([...createDeck(),...createDeck()]); }

// ================================================================
// RENDER
// ================================================================
function renderCard(c, small=false) {
  const sm = small ? ' ncard' : '';
  if (c.hidden) return `<div class="card back${sm}"></div>`;
  const cls = RED.has(c.suit) ? 'red' : 'black';
  return `<div class="card ${cls}${sm}" style="animation:cDeal .26s cubic-bezier(.34,1.56,.64,1) both">
    <div class="c-corner"><span class="c-val">${c.value}</span><span class="c-suit">${c.suit}</span></div>
    <div class="c-mid">${c.suit}</div>
    <div class="c-corner bot"><span class="c-val">${c.value}</span><span class="c-suit">${c.suit}</span></div>
  </div>`;
}

function updateUI() {
  // HUD
  $('hudChips').textContent = G.chips;
  $('hudBet').textContent   = G.phase === 'bet' ? '‚Äî' : '$'+G.bet;
  $('hudRound').textContent = G.round;
  document.querySelectorAll('.s-dot').forEach((d,i)=>d.classList.toggle('lit', i<G.strikes));

  // Dealer
  $('dealerHand').innerHTML = G.dealerHand.map(c=>renderCard(c)).join('');
  const visHand  = G.dealerHand.filter(c=>!c.hidden);
  const dtEl     = $('dealerTotal');
  if (G.phase==='dealer'||G.phase==='over') {
    dtEl.textContent = 'Total: '+total(G.dealerHand);
  } else {
    dtEl.textContent = visHand.length ? 'Showing: '+total(visHand) : '';
  }

  // Player
  const hands = G.splitHands || [G.playerHand];
  $('playerHand').innerHTML = hands.map((h,i)=>{
    const cls = (G.splitHands && i===G.splitIndex) ? ' split-active' : '';
    return `<div class="${cls}" style="display:flex;gap:7px">${h.map(c=>renderCard(c)).join('')}</div>`;
  }).join('');
  const cur   = G.splitHands ? G.splitHands[G.splitIndex] : G.playerHand;
  const pt    = total(cur);
  const ptEl  = $('playerTotal');
  if (G.phase==='bet') { ptEl.textContent=''; ptEl.className='player-total'; }
  else { ptEl.textContent = pt>21 ? 'üíÄ BUST ‚Äî '+pt : 'Total: '+pt; ptEl.className='player-total'+(pt>21?' bust':''); }

  // NPCs ‚Äî use c (not npc1Hand[0])
  $('npc1Hand').innerHTML = G.npc1Hand.map(c=>
    G.phase==='over' ? renderCard({...c,hidden:false},true) : `<div class="card back ncard"></div>`
  ).join('');
  $('npc2Hand').innerHTML = G.npc2Hand.map(c=>
    G.phase==='over' ? renderCard({...c,hidden:false},true) : `<div class="card back ncard"></div>`
  ).join('');

  // Swap banner + label
  $('swapBanner').classList.toggle('on', G.soulSwapped);
  $('playerLbl').textContent = G.soulSwapped ? 'Your Hand (as Dealer)' : 'Your Hand';

  // Bet display
  $('betAmt').textContent    = '$'+G.bet;
  const btnDeal = $('btnDeal');
  if (btnDeal) btnDeal.disabled = G.chips<10 || G.bet>G.chips || G.bet<10;

  // Action button states
  if (G.phase==='player') {
    $('actionBet').textContent = '$'+G.bet;
    const h   = G.splitHands ? G.splitHands[G.splitIndex] : G.playerHand;
    const raw = G.playerHand;
    const canSplit = !G.splitHands && raw.length===2 && cardValue(raw[0].value)===cardValue(raw[1].value) && G.chips>=G.bet;
    $('btnSplit').disabled  = !canSplit;
    $('btnDouble').disabled = h.length!==2 || G.chips<G.bet;
  }
}

function $(id) { return document.getElementById(id); }

// ================================================================
// PHASE MANAGER
// ================================================================
function showPhase(p) {
  $('betControls').style.display    = p==='bet'    ? ''     : 'none';
  $('actionControls').style.display = p==='player' ? ''     : 'none';
  $('dealerControls').style.display = p==='dealer' ? ''     : 'none';
  $('nextControls').style.display   = p==='over'   ? ''     : 'none';
}

// ================================================================
// SCREENS
// ================================================================
function startGame() {
  initDeck();
  $('titleScreen').classList.add('hidden');
  $('gameScreen').classList.remove('hidden');
  G.phase = 'bet'; showPhase('bet'); updateUI();
}

// ================================================================
// BET
// ================================================================
function addChip(v) { G.bet = Math.min(G.bet+v, G.chips, 500); updateUI(); }
function clearBet()  { G.bet = Math.min(10, G.chips); updateUI(); }

// ================================================================
// DEAL ‚Äî staggered animation
// ================================================================
function dealHand() {
  if (G.bet<10 || G.bet>G.chips) return;
  G.chips      -= G.bet;
  G.playerHand  = []; G.dealerHand = [];
  G.npc1Hand    = [draw(), draw()];
  G.npc2Hand    = [draw(), draw()];
  G.splitHands  = null; G.splitIndex = 0;
  G.insuranceTaken = false; G.insurance = 0;
  G.phase = 'player'; showPhase('player'); updateUI();

  // Deal 4 cards: Player, Dealer, Player, Dealer(hidden) ‚Äî 180 ms apart
  [
    ()=>{ G.playerHand.push(draw());       sfxDeal(); updateUI(); },
    ()=>{ G.dealerHand.push(draw());        sfxDeal(); updateUI(); },
    ()=>{ G.playerHand.push(draw());        sfxDeal(); updateUI(); },
    ()=>{ G.dealerHand.push(draw(true));    sfxDeal(); updateUI(); },
  ].forEach((fn,i)=>setTimeout(fn, i*180));

  setTimeout(afterDeal, 4*180+100);
}

function afterDeal() {
  npcReact();
  if (G.dealerHand[0]?.value==='A') showIns();
  else checkBJ();
}

function checkBJ() {
  if (total(G.playerHand)===21 && G.playerHand.length===2) {
    G.dealerHand.forEach(c=>c.hidden=false);
    updateUI();
    endRound(total(G.dealerHand)===21 ? 'push' : 'blackjack');
  }
}

// ================================================================
// INSURANCE
// ================================================================
function showIns() { $('insModal').classList.add('show'); }
function takeInsurance(yes) {
  $('insModal').classList.remove('show');
  if (yes) {
    const ins = Math.floor(G.bet/2);
    G.insurance = ins; G.chips -= ins; G.insuranceTaken = true; updateUI();
  }
  checkBJ();
}

// ================================================================
// PLAYER ACTIONS
// ================================================================
function playerHit() {
  if (G.phase!=='player') return;
  const h = G.splitHands ? G.splitHands[G.splitIndex] : G.playerHand;
  h.push(draw()); sfxDeal(); updateUI();
  const t = total(h);
  if (t>21) {
    if (G.splitHands && G.splitIndex<G.splitHands.length-1) {
      setTimeout(()=>{ G.splitIndex++; updateUI(); }, 300);
    } else setTimeout(()=>endRound('bust'), 450);
  } else if (t===21) playerStand();
}

function playerStand() {
  if (G.phase!=='player') return;
  if (G.splitHands && G.splitIndex<G.splitHands.length-1) {
    G.splitIndex++; updateUI(); return;
  }
  G.phase = 'dealer'; showPhase('dealer'); updateUI();
  setTimeout(dealerPlay, 600);
}

function playerDouble() {
  if (G.phase!=='player'||G.chips<G.bet) return;
  G.chips -= G.bet; G.bet *= 2; updateUI();
  const h = G.splitHands ? G.splitHands[G.splitIndex] : G.playerHand;
  h.push(draw()); sfxDeal(); updateUI();
  setTimeout(()=>{ if(total(h)<=21) playerStand(); else endRound('bust'); }, 420);
}

function playerSplit() {
  if (G.phase!=='player'||G.chips<G.bet||G.splitHands) return;
  G.chips -= G.bet;
  G.splitHands = [[G.playerHand[0],draw()],[G.playerHand[1],draw()]];
  G.splitIndex = 0; sfxDeal(); updateUI();
}

// ================================================================
// DEALER PLAY
// ================================================================
function dealerPlay() {
  G.dealerHand.forEach(c=>c.hidden=false); updateUI();
  function step() {
    if (total(G.dealerHand)<17) {
      setTimeout(()=>{ G.dealerHand.push(draw()); sfxDeal(); updateUI(); step(); }, 660);
    } else setTimeout(resolveRound, 400);
  }
  step();
}

function resolveRound() {
  const dt    = total(G.dealerHand);
  const hands = G.splitHands || [G.playerHand];
  let netGain = 0, lastResult = 'lose';

  hands.forEach(h=>{
    const pt      = total(h);
    const handBet = G.bet / (G.splitHands ? G.splitHands.length : 1);
    if (pt>21) { /* bust ‚Äî nothing */ }
    else if (dt>21||pt>dt) { netGain+=handBet*2; lastResult='win'; }
    else if (pt===dt)      { netGain+=handBet;   lastResult='push'; }
    else                   {                      lastResult='lose'; }
  });

  if (G.insuranceTaken && total(G.dealerHand)===21 && G.dealerHand.length===2)
    netGain += G.insurance*3;

  G.chips += netGain; updateUI();
  endRound(lastResult);
}

// ================================================================
// END ROUND
// ================================================================
function endRound(result) {
  G.phase = 'over'; showPhase('over');

  let icon, text, cls, delta=0;
  if (result==='blackjack') {
    // Bet already deducted; return 2.5√ó (original + 1.5√ó bonus)
    G.chips += Math.floor(G.bet*2.5);
    delta = Math.floor(G.bet*1.5);
    icon='üÉè'; text='BLACKJACK!'; cls='bj'; sfxWin();
  } else if (result==='win') {
    // resolveRound already added 2√ó handBet ‚Äî net profit = G.bet
    delta = G.bet;
    icon='üí∞'; text='YOU WIN!'; cls='win'; sfxWin();
  } else if (result==='push') {
    // resolveRound already returned the bet ‚Äî net = 0
    delta = 0;
    icon='ü§ù'; text='PUSH'; cls='push';
  } else if (result==='bust') {
    delta = -G.bet; icon='üíÄ'; text='BUST!'; cls='lose'; sfxLose();
  } else {
    delta = -G.bet; icon='‚ò†Ô∏è'; text='DEALER WINS'; cls='lose'; sfxLose();
  }

  updateUI();
  showResult(icon, text, cls, delta);

  // Soul swap countdown
  G.roundsUntilSwap--;
  if (G.soulSwapped) G.soulSwapped=false;
  if (G.roundsUntilSwap<=0) {
    G.roundsUntilSwap = rndSwap();
    setTimeout(triggerSoulSwap, 2200);
  }

  // Game over?
  if (G.chips<=0) {
    setTimeout(()=>{
      hideResult();
      $('gameScreen').classList.add('hidden');
      $('gameOverScreen').classList.remove('hidden');
      $('goChips').textContent = 'Final chips: 0';
    }, 3400);
  }
}

function showResult(icon, text, cls, delta) {
  $('rIcon').textContent = icon;
  $('rText').textContent = text;
  $('rText').className   = 'r-text '+cls;
  $('resultBox').className = 'result-box '+cls;
  const chEl = $('rChips');
  if (delta>0) chEl.innerHTML  = `+${delta} chips &nbsp;¬∑&nbsp; Total: <span class="pos">${G.chips}</span>`;
  else if (delta<0) chEl.innerHTML = `${delta} chips &nbsp;¬∑&nbsp; Total: <span class="neg">${G.chips}</span>`;
  else chEl.innerHTML = `Bet returned &nbsp;¬∑&nbsp; Total: <span class="pos">${G.chips}</span>`;
  $('resultOverlay').classList.add('show');
}
function hideResult() { $('resultOverlay').classList.remove('show'); }

// ================================================================
// NEXT ROUND
// ================================================================
function nextRound() {
  hideResult();
  G.round++; G.phase='bet';
  G.playerHand=[]; G.dealerHand=[]; G.npc1Hand=[]; G.npc2Hand=[];
  G.splitHands=null; G.splitIndex=0;
  G.bet = Math.min(G.bet, G.chips);
  if (G.bet<10) G.bet = Math.min(10, G.chips);
  showPhase('bet'); updateUI();
}

// ================================================================
// SOUL SWAP
// ================================================================
function triggerSoulSwap() {
  sfxSwap();
  G.soulSwapped = !G.soulSwapped;
  $('soulSub').textContent = G.soulSwapped
    ? 'You are now the DEALER. Hit ‚â§16, Stand ‚â•17.'
    : 'Souls returned. You are yourself again.';
  $('soulSwap').classList.add('on');
  setTimeout(()=>$('soulSwap').classList.remove('on'), 3000);
}

// ================================================================
// CHEAT / PEEK
// ================================================================
const CATCH_CHANCE = 0.40;

function attemptPeek() {
  if (G.phase!=='player') return;
  Math.random()<CATCH_CHANCE ? triggerCaught() : revealPeek();
}

function revealPeek() {
  const hole = G.dealerHand.find(c=>c.hidden);
  if (!hole) return;
  hole.hidden = false; updateUI();
  const pb = $('peekBubble');
  pb.innerHTML = `üëÅ &nbsp;Hole card: <strong>${hole.value}${hole.suit}</strong>`;
  pb.classList.add('show');
  setTimeout(()=>{ hole.hidden=true; pb.classList.remove('show'); updateUI(); }, 3000);
}

function triggerCaught() {
  G.strikes++; sfxCaught();
  const spr = $('dealerSpr');
  spr.classList.add('charging');
  setTimeout(()=>spr.classList.remove('charging'), 760);

  showCrack();
  const penalty = Math.floor(G.chips*0.20);
  G.chips = Math.max(0, G.chips-penalty); updateUI();

  // Swap to next-controls briefly to show penalty message -- keep action controls
  // (We just show crack + update HUD; don't break the turn)

  if (G.strikes>=G.maxStrikes) {
    setTimeout(()=>{
      $('crack').classList.remove('on');
      $('gameScreen').classList.add('hidden');
      $('gameOverScreen').classList.remove('hidden');
      $('goChips').textContent = '‚ò†Ô∏è Banned for cheating!';
    }, 2900);
  }
}

function showCrack() {
  $('crack').classList.add('on');
  setTimeout(()=>$('crack').classList.remove('on'), 4000);
}

// ================================================================
// NPC REACTIONS
// ================================================================
const EMOTES = ['üò±','ü§î','üëÄ','üòÖ','üòÇ','üíÄ','üôÄ','ü´£','üòÆ','ü§≠','üò¨'];
function npcReact() {
  ['npc1','npc2'].forEach(id=>{
    if (Math.random()<0.55) {
      const el = $(id);
      el.querySelector('.npc-react')?.remove();
      const r = document.createElement('div');
      r.className = 'npc-react';
      r.textContent = EMOTES[Math.floor(Math.random()*EMOTES.length)];
      el.appendChild(r);
      setTimeout(()=>r.remove(), 1600);
    }
  });
}

// ================================================================
// KEYBOARD SHORTCUTS
// ================================================================
document.addEventListener('keydown', e=>{
  if (G.phase==='over'   && e.key==='Enter') { nextRound(); return; }
  if (G.phase!=='player') return;
  switch(e.key.toLowerCase()) {
    case 'h': playerHit(); break;
    case 's': playerStand(); break;
    case 'd': if(!$('btnDouble').disabled) playerDouble(); break;
    case 'x': if(!$('btnSplit').disabled)  playerSplit();  break;
    case 'p': attemptPeek(); break;
  }
});

// ================================================================
// RESET
// ================================================================
function resetGame() {
  Object.assign(G, {
    deck:[], chips:1000, bet:50, round:1, strikes:0,
    phase:'bet', soulSwapped:false, roundsUntilSwap:rndSwap(),
    insurance:0, insuranceTaken:false,
    playerHand:[], dealerHand:[], npc1Hand:[], npc2Hand:[],
    splitHands:null, splitIndex:0,
  });
  initDeck();
  $('gameOverScreen').classList.add('hidden');
  $('gameScreen').classList.remove('hidden');
  $('crack').classList.remove('on');
  hideResult();
  showPhase('bet'); updateUI();
}

// Init
initDeck();
</script>
</body>
</html>
